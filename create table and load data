-- create and drop table products_staging.
DROP TABLE IF EXISTS products_staging;
CREATE TABLE products_staging (
  product_id NVARCHAR(50),
  category NVARCHAR(100),
  brand NVARCHAR(100),
  season NVARCHAR(50),
  size NVARCHAR(20),
  color NVARCHAR(50),
  original_price NVARCHAR(50),
  markdown_percentage NVARCHAR(50),
  current_price NVARCHAR(50),
  purchase_date NVARCHAR(50),
  stock_quantity NVARCHAR(50),
  customer_rating NVARCHAR(50),
  is_returned NVARCHAR(10),
  return_reason NVARCHAR(255)
);

-- load data from csv.
BULK INSERT products_staging
FROM 'F:\da\tableau\Projects\fashion_boutique_dataset.csv'
WITH (
    FIRSTROW = 2,           -- Skip header
    FIELDTERMINATOR = ',', -- Tab separated
    ROWTERMINATOR = '\n',
    CODEPAGE = '65001',     -- Handle UTF-8
    TABLOCK
);

-- update and create products.
DROP TABLE IF EXISTS products;
CREATE TABLE products (
  product_id NVARCHAR(50) PRIMARY KEY,
  category NVARCHAR(100),
  brand NVARCHAR(100),
  season NVARCHAR(50),
  size NVARCHAR(20),
  color NVARCHAR(50),
  original_price DECIMAL(10,2),
  markdown_percentage DECIMAL(5,2),
  current_price DECIMAL(10,2),
  purchase_date DATE,
  stock_quantity INT,
  customer_rating DECIMAL(3,1),
  is_returned BIT,
  return_reason NVARCHAR(255)
);

-- insert data into products
INSERT INTO products (product_id, category, brand, season, size, color, original_price, markdown_percentage, current_price, purchase_date, stock_quantity, customer_rating, is_returned, return_reason)
SELECT
  product_id,
  NULLIF(category,'') ,
  NULLIF(brand,''),
  NULLIF(season,''),
  NULLIF(size,''),
  NULLIF(color,''),
  TRY_CAST(NULLIF(original_price,'') AS DECIMAL(10,2)),
  TRY_CAST(NULLIF(markdown_percentage,'') AS DECIMAL(5,2)),
  TRY_CAST(NULLIF(current_price,'') AS DECIMAL(10,2)),
  TRY_CAST(NULLIF(purchase_date,'') AS DATE) -- if dd/MM/yyyy use CONVERT(date, purchase_date, 103)
    -- If your date is d/M/yyyy, use: CONVERT(date, purchase_date, 103)
  ,TRY_CAST(NULLIF(stock_quantity,'') AS INT),
  TRY_CAST(NULLIF(customer_rating,'') AS DECIMAL(3,1)),
  CASE WHEN LOWER(NULLIF(is_returned,'')) IN ('true','1','yes') THEN 1 ELSE 0 END,
  NULLIF(return_reason,'')
FROM products_staging;

